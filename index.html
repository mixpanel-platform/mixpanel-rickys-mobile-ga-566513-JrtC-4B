<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    
    <script>
      // Run queries and display results here
      var params = {
        type: 'general',  // analysis type for the data, can be 'general', 'unique', or 'average'
        limit: 50         // maximum number of results to return
      };
      
      var tableData = {};
      var eventsQuery = MP.api.topEvents(params)
      
      
      var promises = [];
      var events = [];
      var properties = {};
      
      eventsQuery.done(function(results){

        _.each(_.values(results.values()), function(value){
          console.log(value)
          var propQueryParams = {
            limit: 100    // maximum number of results to return
          };
          
          /* Make topProperties query with each event */
          var propQuery = MP.api.topProperties(value, propQueryParams);
          promises.push(propQuery);
          events.push(value);
            
        });
        
        /* When all of the topEvents are done, let's make a properties query for each Event */
      
        Promise.all(promises).then(function(promiseArray){
          _.each(promiseArray, function(propsObject){
              console.log(propsObject.values())
              _.each(propsObject.values(), function(propValue){
                if (propValue in properties){
                  console.log('in')
                } else {
                  properties[propValue] = ''
                }
              })
              
              /* find index of propsObject */
              
              var index = promiseArray.indexOf(propsObject);
              
              /* Add value to dictionary */
              
              tableData[events[index]] = promiseArray[index].values();
          })
        }).then(function(){
          console.log(properties);
          _.each(_.values(tableData), function(dataObject){
            var keys = dataObject.keys()
            for (i = 0; i < keys.length; i++){
              if (key in dataObject){
                // do nothing
              } else {
                dataObject[key] = 0
              }
            }
          })
        }).then(function(){
          console.log(tableData);
            $('<div class="Spec-Table"></div>').appendTo('body').MPTable(
              {
                data: tableData,
                firstColHeader: 'Event'
              }
            );
        });
      })
      
      
    </script>
  </body>
</html>
